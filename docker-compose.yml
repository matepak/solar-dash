version: "3.8"

services:
  sdo-dash:
    container_name: sdo-dash
    build:
      context: .
      # No args needed if .env is present during build
    restart: unless-stopped

    # Runtime env for Nginx container (if needed)
    environment:
      - NODE_ENV=production

    networks:
      - traefik_default

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.sdo-dash-http.rule=Host(`sdodash.webgrove.pl`)"
      - "traefik.http.routers.sdo-dash-http.entrypoints=web"
      - "traefik.http.services.sdo-dash.loadbalancer.server.port=80"

  backend:
    container_name: solar-dashboard-backend
    build: ./backend
    restart: unless-stopped
    # Backend needs these at runtime to send emails and access Firebase
    environment:
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - FIREBASE_SERVICE_ACCOUNT=${FIREBASE_SERVICE_ACCOUNT}
    # It doesn't need to be on traefik network unless it needs to talk to other containers directly.
    # It just needs internet access to reach Firebase and NOAA APIs.

networks:
  traefik_default:
    external: true
